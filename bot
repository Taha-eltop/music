import discord
from discord.ext import commands
import yt_dlp
import asyncio

intents = discord.Intents.default()
intents.message_content = True
intents.voice_states = True

bot = commands.Bot(command_prefix='!', intents=intents)

@bot.event
async def on_ready():
    print(f'üéµ Bot is online as {bot.user}')

@bot.command()
async def join(ctx):
    if ctx.author.voice:
        channel = ctx.author.voice.channel
        await channel.connect()
        await ctx.send(f"‚úÖ Joined {channel.name}")
    else:
        await ctx.send("‚ùå You need to be in a voice channel.")

@bot.command()
async def play(ctx, url):
    if not ctx.voice_client:
        if ctx.author.voice:
            await ctx.author.voice.channel.connect()
        else:
            return await ctx.send("‚ùå You're not in a voice channel.")

    vc = ctx.voice_client

    # Stop if something is already playing
    if vc.is_playing():
        vc.stop()

    # YouTube audio options
    ydl_opts = {
        'format': 'bestaudio/best',
        'quiet': True,
        'extractaudio': True,
        'audioformat': 'mp3',
        'outtmpl': 'song.%(ext)s',
        'noplaylist': True,
    }

    # Download audio
    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        info = ydl.extract_info(url, download=True)
        filename = ydl.prepare_filename(info)

    # Play audio
    vc.play(discord.FFmpegPCMAudio(source=filename), after=lambda e: print('üéµ Playback finished'))

    await ctx.send(f"üé∂ Now playing: {info['title']}")

@bot.command()
async def stop(ctx):
    if ctx.voice_client:
        await ctx.voice_client.disconnect()
        await ctx.send("üõë Disconnected from voice.")
    else:
        await ctx.send("‚ùå I'm not in a voice channel.")

bot.run("MTI5NDM2NzIxMzI4NTAxOTcxOA.G96_fP.D7oyJX5sNJ4RfcPIQdQuSnYkEo22YL6Z_rcXkQ")
